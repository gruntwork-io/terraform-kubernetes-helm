# K8S Tiller TLS Certs Module

This Terraform Module can be used to generate a Certificate Authority (CA) public key, that is then used to generate a
signed TLS certificate. These certs are then stored in a Kubernetes `Secret` so that they can be used with Tiller and
`kubergrunt` to manage authentication to Tiller.

If you are unfamiliar with how TLS works, checkout [this primer on
TLS/SSL](https://github.com/hashicorp/terraform-aws-vault/tree/master/modules/private-tls-cert#background).

You can read more about Helm, Tiller, and their security model in our [Helm
guide](https://github.com/gruntwork-io/kubergrunt/blob/master/HELM_GUIDE.md).

**WARNING: The private keys generated by this module will be stored unencrypted in your Terraform state file. If you are
sensitive to storing secrets in your Terraform state file, consider using `kubergrunt` to generate and manage your TLS
certificate. See [the k8s-tiller-kubergrunt-minikube example](/examples/k8s-tiller-kubergrunt-minikube) for how to use
`kubergrunt` for TLS management.**


## How do you use this module?

* See the [root README](/README.md) for instructions on using Terraform modules.
* This module uses [the `kubernetes` provider](https://www.terraform.io/docs/providers/kubernetes/index.html).
* See the [examples](/examples) folder for example usage.
* See [variables.tf](./variables.tf) for all the variables you can set on this module.
* See [outputs.tf](./outputs.tf) for all the variables that are outputed by this module.


## How do you use the generated TLS certs with Tiller?

This module will generate TLS certificate key pairs and store them in a Kubernetes `Secret`, outputting the name of the
`Secret`. You can then pass the `Secret` name (output variable `signed_tls_certificate_key_pair_secret_name`) to the
[k8s-tiller module](../k8s-tiller) as the input variable `tiller_tls_secret_name`. Tiller will then be able to find the
generated TLS certificate key pairs and mount them into the container so that the server can use it.


## How do you use the generated TLS certs with kubergrunt for client side TLS management?

`kubergrunt` provides TLS management features that can be used for managing client side TLS certs for use with `helm`.
This module is compatible with the `kubergrunt` approach, although it requires a few labels on the created `Secret`
resource so that `kubergrunt` can properly find the CA private key.

`kubergrunt` model of client side TLS management works by looking for the `Secret` that stores the CA certificate key
pair, which it can use to generate client side TLS certs to authenticate the client. These CA certs need to be the ones
used for generating the server side TLS certs, so that the two way verification works.

To allow `kubergrunt` to find the TLS certs, the following must be set:

```hcl
# kubergrunt looks for CA certs in the kube-system Namespace.
ca_tls_certificate_key_pair_secret_namespace = "kube-system"
# kubergrunt uses the following labels to look for Tiller related certs
ca_tls_certificate_key_pair_secret_labels = {
    "gruntwork.io/tiller-namespace" = "{NAME_OF_TILLER_NAMESPACE}"
    "gruntwork.io/tiller-credentials" = "true"
    "gruntwork.io/tiller-credentials-type" = "ca"
}
# kubergrunt uses the following name to look for the CA certs
ca_tls_certificate_key_pair_secret_name = "{NAME_OF_TILLER_NAMESPACE}-namespace-tiller-ca-certs"
```

With these input variables, `kubergrunt` should be able to locate the generated CA certs and use them to generate client
side certs when you use the `kubergrunt helm grant` command.
