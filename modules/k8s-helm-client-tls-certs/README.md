# K8S Helm Client TLS Certs Module

<!-- NOTE: We use absolute linking here instead of relative linking, because the terraform registry does not support
           relative linking correctly.
-->

This Terraform Module can be used to generate a signed TLS certificate key pair that can be used to authenticate the
`helm` client with Tiller. These certs are optionally then stored in a Kubernetes `Secret`, that can then be shared with
the client. Note that the `Secret` is configured such that it is compatible with `kubergrunt helm configure` for setting
up the `helm` client.

This module assumes the CA certs are stored as Kubernetes `Secrets` on the cluster, either via `kubergrunt` or the
[k8s-tiller-tls-certs module](https://github.com/gruntwork-io/terraform-kubernetes-helm/blob/master/modules/k8s-tiller-tls-certs).

If you are unfamiliar with how TLS works, checkout [this primer on
TLS/SSL](https://github.com/hashicorp/terraform-aws-vault/tree/master/modules/private-tls-cert#background).

You can read more about Helm, Tiller, and their security model in our [Helm
guide](https://github.com/gruntwork-io/kubergrunt/blob/master/HELM_GUIDE.md).

**WARNING: The private keys generated by this module will be stored unencrypted in your Terraform state file. If you are
sensitive to storing secrets in your Terraform state file, consider using `kubergrunt` to generate and manage your TLS
certificate. See [the k8s-tiller-kubergrunt-minikube example](/examples/k8s-tiller-kubergrunt-minikube) for how to use
`kubergrunt` for TLS management.**


## How do you use this module?

* See the [root README](https://github.com/gruntwork-io/terraform-kubernetes-helm/blob/master/README.md) for
  instructions on using Terraform modules.
* This module uses [the `kubernetes` provider](https://www.terraform.io/docs/providers/kubernetes/index.html).
* See the [examples](https://github.com/gruntwork-io/terraform-kubernetes-helm/blob/master/examples) folder for example
  usage.
* See [variables.tf](https://github.com/gruntwork-io/terraform-kubernetes-helm/blob/master/modules/k8s-helm-client-tls-certs/variables.tf)
  for all the variables you can set on this module.
* See [outputs.tf](https://github.com/gruntwork-io/terraform-kubernetes-helm/blob/master/modules/k8s-helm-client-tls-certs/outputs.tf)
  for all the variables that are outputed by this module.


## How do I configure Helm to use the generated TLS certs?

To configure the `helm` client to use the generated TLS certs, the certs must first be downloaded on to the machine.
There are two ways to access the generated TLS certs:

- Directly using the module outputs
- Via the Kubernetes `Secret` (if `var.store_in_kubernetes_secret` is `true`)

These certs should be shared with the user so that they can install it on their machine. Once the certs are shared, they
need to be stored on the local file system where the `helm` home directory is. By default the `helm` home directory is
`$HOME/.helm`, but this is configurable. In the `helm` home directory, store the certs under the names:

- `ca.crt`: The CA public certificate file, encoded in PEM format.
- `client.pem`: The private key of the client TLS certificate key pair, encoded in PEM format.
- `client.crt`: The public certificate of the client TLS certificate key pair, encoded in PEM format.

Once the certificate key pairs are stored, the `helm` client will automatically discover them when connecting to Tiller
with TLS enabled. You need to pass in the CLI args `--tls` and `--tls-verify` to enable TLS verification with the
client. For example, to run the `ls` command to list releases:

```bash
helm ls --tls --tls-verify
```

Note that the CLI args must come after the subcommand.
